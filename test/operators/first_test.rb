require_relative '../helper'

describe ConceptQL::Operators::First do
  it "should produce correct results" do
    criteria_ids(
      [:first, [:icd9, "412"]]
    ).must_equal("condition_occurrence"=>[2151, 2428, 3995, 4545, 5069, 5263, 5582, 8725, 11135, 11589, 11800, 13234, 14702, 14854, 14859, 17103, 23234, 23411, 24627, 25492, 26245, 37521, 38787, 50019, 52644, 52675, 53214, 53216, 53251, 53801, 55383, 56352, 56634, 57089, 57705, 58271, 58448, 58596, 58623, 59732, 59760, 59785])

    criteria_ids(
      [:first, [:cpt, "99214"]]
    ).must_equal("procedure_occurrence"=>[70, 180, 257, 416, 426, 631, 655, 691, 697, 714, 836, 915, 989, 1025, 1101, 1199, 1214, 1224, 1243, 1254, 1285, 1355, 1489, 1647, 1693, 1695, 1756, 1790, 1811, 1860, 1977, 2004, 2032, 2274, 2423, 2435, 2495, 2509, 2646, 2801, 2906, 3022, 3052, 3056, 3060, 3089, 3097, 3107, 3140, 3176, 3272, 3327, 3413, 3540, 3557, 3565, 3639, 3649, 3687, 3695, 3721, 3724, 3766, 3817, 3895, 3944, 3978, 3989, 4078, 4137, 4320, 4538, 4600, 4620, 4693, 4800, 4881, 4997, 5016, 5041, 5147, 5190, 5201, 5222, 5398, 5448, 5469, 5577, 5675, 5709, 5746, 5765, 5778, 5824, 6093, 6158, 6364, 6415, 6506, 6589, 6761, 6927, 6984, 6996, 7005, 7217, 7417, 7422, 7436, 7450, 7495, 7540, 7552, 7593, 7660, 7673, 7805, 8000, 8006, 8068, 8128, 8290, 8321, 8376, 8442, 8486, 8512, 8533, 8540, 8586, 8778, 8794, 8896, 8929, 8998, 9026, 9122, 9209, 9283, 9299, 9323, 9345, 9358, 9529, 9765, 9848, 10090, 10152, 10297, 10327, 10413, 10545, 10755, 10805, 10854, 10900, 10916, 11023, 11043, 11083, 11234, 11247, 11373, 11391, 11409, 11453, 11548, 11569, 11590, 11659, 11708, 11732, 11764, 11768, 11779, 12181, 12365, 12370, 12475, 13004, 14046, 15087, 15704, 15942, 16636, 18998, 22145, 24110, 24167, 24247, 24311, 25210, 25454, 25553, 25718, 26739, 27333, 32373, 33068, 33315, 35561, 36173, 36869])

    criteria_ids(
      [:first, [:union, [:icd9, "412"], [:death, true]]]
    ).must_equal("death"=>[177], "condition_occurrence"=>[2151, 2428, 3995, 4545, 5069, 5263, 5582, 8725, 11135, 11589, 11800, 13234, 14702, 14854, 14859, 17103, 23234, 23411, 24627, 25492, 26245, 37521, 38787, 50019, 52644, 52675, 53214, 53216, 53251, 53801, 55383, 56352, 56634, 57089, 57705, 58271, 58448, 58596, 58623, 59732, 59760, 59785])
  end

  it "should handle errors when annotating" do
    query(
      [:first]
    ).annotate.must_equal(
      ["first", {:annotation=>{:counts=>{:invalid=>{:rows=>0, :n=>0}}, :errors=>[["has no upstream"]]}}]
    )

    query(
      [:first, 1]
    ).annotate.must_equal(
      ["first", 1, {:annotation=>{:counts=>{:invalid=>{:rows=>0, :n=>0}}, :errors=>[["has no upstream"], ["has arguments"]]}}]
    )
  end
end

