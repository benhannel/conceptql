require_relative '../helper'

describe ConceptQL::Operators::TimeWindow do
  it "should produce correct results" do
    criteria_ids(
      [:time_window, [:icd9, "412"], {:start=>"-2y", :end=>"-2y"}]
    ).must_equal("condition_occurrence"=>[2151, 2428, 3995, 4545, 4710, 5069, 5263, 5582, 8725, 10403, 10590, 11135, 11228, 11589, 11800, 13234, 13893, 14604, 14702, 14854, 14859, 17103, 17593, 23234, 23411, 24627, 25492, 26245, 27343, 37521, 38787, 50019, 50933, 52644, 52675, 53214, 53216, 53251, 53630, 53733, 53801, 55383, 56352, 56634, 56970, 57089, 57705, 58271, 58448, 58596, 58610, 58623, 59732, 59760, 59785])

    criteria_ids(
      [:time_window, [:place_of_service_code, "21"], {:start=>"", :end=>"start"}]
    ).must_equal("visit_occurrence"=>[1, 8, 9, 10, 11, 507, 729, 730, 731, 732, 1125, 1155, 1265, 1325, 1389, 1390, 1585, 1586, 1683, 1791, 1879, 1880, 2207, 2208, 2209, 2352, 2353, 2354, 2704, 2705, 2808, 2936, 2937, 3079, 3080, 3081, 3185, 3186, 3187, 3188, 3189, 3359, 3376, 3699, 3700, 3802, 3830, 3846, 3847, 3996, 3997, 3998, 4146, 4245, 4364, 4376, 4377, 4378, 4379, 4380, 4575, 4576, 4795, 4796, 4797, 4857, 4858, 4859, 4860, 4861, 5001, 5002, 5212, 6309, 6310, 6640, 6641, 6642, 6784, 6833, 6834, 6879, 7002, 7003, 7325, 7396, 7464, 7824, 7832, 7952, 8108, 8127, 8349, 8350, 8556, 8557, 8708, 8806, 8851, 8852, 8972, 8973, 8974, 8975, 9242, 9449, 9450, 9901, 9948, 9949, 10046, 10181, 10182, 10303, 10304, 10407, 10474, 10766, 10793, 10794, 10795, 11071, 11139, 11555, 11615, 11781, 11782, 11783, 11784, 12005, 12019, 12020, 12157, 12158, 12198, 12324, 12325, 12326, 12531, 12606, 12663, 12664, 12665, 12666, 12667, 12668, 12669, 12670, 12889, 12890, 13037, 13321, 13322, 13323, 13324, 13325, 13606, 13903, 13972, 13973, 14151, 14152, 14153, 14204, 14344, 14345, 14441, 14442, 14920, 15011])

    criteria_ids(
      [:time_window, [:icd9, "412"], {:start=>"-2m-2d", :end=>"3d1y"}]
    ).must_equal("condition_occurrence"=>[2151, 2428, 3995, 4545, 4710, 5069, 5263, 5582, 8725, 10403, 10590, 11135, 11228, 11589, 11800, 13234, 13893, 14604, 14702, 14854, 14859, 17103, 17593, 23234, 23411, 24627, 25492, 26245, 27343, 37521, 38787, 50019, 50933, 52644, 52675, 53214, 53216, 53251, 53630, 53733, 53801, 55383, 56352, 56634, 56970, 57089, 57705, 58271, 58448, 58596, 58610, 58623, 59732, 59760, 59785])

    criteria_ids(
      [:time_window, [:place_of_service_code, "21"], {:start=>"end", :end=>"start"}]
    ).must_equal("visit_occurrence"=>[1, 8, 9, 10, 11, 507, 729, 730, 731, 732, 1125, 1155, 1265, 1325, 1389, 1390, 1585, 1586, 1683, 1791, 1879, 1880, 2207, 2208, 2209, 2352, 2353, 2354, 2704, 2705, 2808, 2936, 2937, 3079, 3080, 3081, 3185, 3186, 3187, 3188, 3189, 3359, 3376, 3699, 3700, 3802, 3830, 3846, 3847, 3996, 3997, 3998, 4146, 4245, 4364, 4376, 4377, 4378, 4379, 4380, 4575, 4576, 4795, 4796, 4797, 4857, 4858, 4859, 4860, 4861, 5001, 5002, 5212, 6309, 6310, 6640, 6641, 6642, 6784, 6833, 6834, 6879, 7002, 7003, 7325, 7396, 7464, 7824, 7832, 7952, 8108, 8127, 8349, 8350, 8556, 8557, 8708, 8806, 8851, 8852, 8972, 8973, 8974, 8975, 9242, 9449, 9450, 9901, 9948, 9949, 10046, 10181, 10182, 10303, 10304, 10407, 10474, 10766, 10793, 10794, 10795, 11071, 11139, 11555, 11615, 11781, 11782, 11783, 11784, 12005, 12019, 12020, 12157, 12158, 12198, 12324, 12325, 12326, 12531, 12606, 12663, 12664, 12665, 12666, 12667, 12668, 12669, 12670, 12889, 12890, 13037, 13321, 13322, 13323, 13324, 13325, 13606, 13903, 13972, 13973, 14151, 14152, 14153, 14204, 14344, 14345, 14441, 14442, 14920, 15011])
  end

  it "should handle errors when annotating" do
    query(
      [:time_window, {:start=>"-2y", :end=>"-2y"}]
    ).annotate.must_equal(
      ["time_window", {:start=>"-2y", :end=>"-2y", :annotation=>{:counts=>{:invalid=>{:n=>0, :rows=>0}}, :errors=>[["has no upstream"]]}}]
    )

    query(
      [:time_window, [:icd9, "412"], {:start=>2, :end=>2}]
    ).annotate.must_equal(
      ["time_window",
       ["icd9", "412", {:annotation=>{:counts=>{:condition_occurrence=>{:rows=>55, :n=>42}}}, :name=>"ICD-9 CM"}],
       {:start=>2, :end=>2, :annotation=>{:counts=>{:condition_occurrence=>{:n=>0, :rows=>0}}, :errors=>[["wrong option format", "start"], ["wrong option format", "end"]]}}]
    )

    query(
      [:time_window, [:icd9, "412"], {:start=>"-2b", :end=>"-2y"}]
    ).annotate.must_equal(
      ["time_window",
       ["icd9", "412", {:annotation=>{:counts=>{:condition_occurrence=>{:rows=>55, :n=>42}}}, :name=>"ICD-9 CM"}],
       {:start=>"-2b", :end=>"-2y", :annotation=>{:counts=>{:condition_occurrence=>{:n=>0, :rows=>0}}, :errors=>[["wrong option format", "start"]]}}]
    )

    query(
      [:time_window, 21, [:icd9, "412"], {:start=>"-2y", :end=>"-2y"}]
    ).annotate.must_equal(
      ["time_window",
       ["icd9", "412", {:annotation=>{:counts=>{:condition_occurrence=>{:rows=>55, :n=>42}}}, :name=>"ICD-9 CM"}],
       21,
       {:start=>"-2y", :end=>"-2y", :annotation=>{:counts=>{:condition_occurrence=>{:n=>0, :rows=>0}}, :errors=>[["has arguments", [21]]]}}]
    )

    query(
      [:time_window, [:icd9, "412"], [:place_of_service_code, "21"], {:start=>"-2y", :end=>"-2y"}]
    ).annotate.must_equal(
      ["time_window",
       ["icd9", "412", {:annotation=>{:counts=>{:condition_occurrence=>{:rows=>55, :n=>42}}}, :name=>"ICD-9 CM"}],
       ["place_of_service_code", "21", {:annotation=>{:counts=>{:visit_occurrence=>{:rows=>170, :n=>92}}}}],
       {:start=>"-2y", :end=>"-2y", :annotation=>{:counts=>{:visit_occurrence=>{:rows=>0, :n=>0}, :condition_occurrence=>{:n=>0, :rows=>0}},:errors=>[["has multiple upstreams", ["icd9", "place_of_service_code"]]]}}]
    )
  end
end
